{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Canvas3D Scene Spec",
  "type": "object",
  "required": ["version", "domain", "seed", "objects", "lighting", "camera"],
  "properties": {
    "version": { "type": "string", "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$" },
    "domain": { "type": "string", "enum": ["procedural_dungeon", "film_interior"] },
    "units": { "type": "string", "enum": ["meters"], "default": "meters" },
    "seed": { "type": "integer", "minimum": 0 },
    "metadata": {
      "type": "object",
      "properties": {
        "quality_mode": { "type": "string", "enum": ["lite", "balanced", "high"], "default": "balanced" },
        "hardware_profile": { "type": "string" },
        "notes": { "type": "string" }
      }
    },
    "grid": {
      "type": "object",
      "required": ["cell_size_m", "dimensions"],
      "properties": {
        "cell_size_m": { "type": "number", "minimum": 0.25, "maximum": 5.0 },
        "dimensions": {
          "type": "object",
          "required": ["cols", "rows"],
          "properties": {
            "cols": { "type": "integer", "minimum": 5, "maximum": 200 },
            "rows": { "type": "integer", "minimum": 5, "maximum": 200 }
          }
        }
      }
    },
    "objects": {
      "type": "array",
      "items": { "$ref": "#/definitions/object" }
    },
    "lighting": {
      "type": "array",
      "items": { "$ref": "#/definitions/light" },
      "minItems": 1
    },
    "camera": { "$ref": "#/definitions/camera" },
    "materials": {
      "type": "array",
      "items": { "$ref": "#/definitions/material" },
      "default": []
    },
    "collections": {
      "type": "array",
      "items": { "$ref": "#/definitions/collection" },
      "default": []
    },
    "constraints": {
      "type": "object",
      "properties": {
        "min_path_length_cells": { "type": "integer", "minimum": 5 },
        "require_traversable_start_to_goal": { "type": "boolean", "default": true },
        "max_polycount": { "type": "integer", "minimum": 1000 }
      }
    }
  },
  "allOf": [
    {
      "if": { "properties": { "domain": { "const": "procedural_dungeon" } } },
      "then": { "required": ["grid"] }
    }
  ],
  "definitions": {
    "vec3": {
      "type": "array",
      "items": { "type": "number" },
      "minItems": 3,
      "maxItems": 3
    },
    "object": {
      "type": "object",
      "required": ["id", "type"],
      "properties": {
        "id": { "type": "string", "pattern": "^[a-zA-Z0-9_\\-]+$" },
        "type": {
          "type": "string",
          "enum": [
            "cube",
            "plane",
            "cylinder",
            "corridor_segment",
            "room",
            "door",
            "stair",
            "prop_instance"
          ]
        },
        "position": { "$ref": "#/definitions/vec3" },
        "rotation_euler": { "$ref": "#/definitions/vec3" },
        "scale": { "$ref": "#/definitions/vec3" },
        "grid_cell": {
          "type": "object",
          "properties": { "col": { "type": "integer" }, "row": { "type": "integer" } }
        },
        "material": { "type": "string" },
        "collection": { "type": "string" },
        "properties": { "type": "object" }
      }
    },
    "light": {
      "type": "object",
      "required": ["type", "position", "intensity"],
      "properties": {
        "type": { "type": "string", "enum": ["sun", "point", "area", "spot"] },
        "position": { "$ref": "#/definitions/vec3" },
        "rotation_euler": { "$ref": "#/definitions/vec3" },
        "intensity": { "type": "number", "minimum": 0.0, "maximum": 10000.0 },
        "color_rgb": {
          "type": "array",
          "items": { "type": "number", "minimum": 0.0, "maximum": 1.0 },
          "minItems": 3,
          "maxItems": 3,
          "default": [1.0, 1.0, 1.0]
        }
      }
    },
    "camera": {
      "type": "object",
      "required": ["position", "rotation_euler"],
      "properties": {
        "position": { "$ref": "#/definitions/vec3" },
        "rotation_euler": { "$ref": "#/definitions/vec3" },
        "fov_deg": { "type": "number", "minimum": 20.0, "maximum": 120.0, "default": 60.0 }
      }
    },
    "material": {
      "type": "object",
      "required": ["name"],
      "properties": {
        "name": { "type": "string" },
        "pbr": {
          "type": "object",
          "properties": {
            "base_color": {
              "type": "array",
              "items": { "type": "number", "minimum": 0.0, "maximum": 1.0 },
              "minItems": 3,
              "maxItems": 3
            },
            "metallic": { "type": "number", "minimum": 0.0, "maximum": 1.0 },
            "roughness": { "type": "number", "minimum": 0.0, "maximum": 1.0 },
            "normal_tex": { "type": "string" }
          }
        }
      }
    },
    "collection": {
      "type": "object",
      "required": ["name"],
      "properties": {
        "name": { "type": "string" },
        "purpose": { "type": "string", "enum": ["geometry", "props", "lighting", "physics"] }
      }
    }
  }
}